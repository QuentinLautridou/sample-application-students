language: java
jdk: oraclejdk8

env:
  global:
    - secure: OxWfcJjIp48+JBJbNn+xV0VkszfaEEecdVSTXQk9g/e/dHinrAwv8lrH1MWxqdMfPefiJWnXH/YTfrTSTqslk8SawEs7WU8sqiY8mIDVlHVU9JOlGxNleLzQTjHsW0r6dBNaHZhNv8xzhQuuzHHQ243uiTYxgSN96mGboho10eczcmEgx1tHT6yZ/oWJjKK9jnlBXvkVDYZG7thyVEnBHKkag+XzSxmcPiuVQ/xCfiDksnfCjnCdnk5YBG4K5ySmoFurdeTA1kvbqeEUS0mVUssi6A3XtH9Tu+cPHOx9VUuhI8j3JBBVR5fwSveX/bnST0qZpqAliZGsKjVK+WcHA4sNyF+6m1wf0Z61DF2ZQl7Aen4opTsvcKaZ4d0luQ3PSUsqfev3yq1WUERy04wk5VqMK3/xsENwqf5+i6Xv70i1X2chuY8mnpugobzL4aykI5dG7oLubgzUWvdJqBMZzJiPED7/VWr7gU4m9vIfZ3AntzGn+uebYV6czcMZbt8YfbNjy2/gCNDLNCEhoAp3SaXRMxISHeCU2pK9BcpaHNf+2Jpu2rGQa/+r/86ApTVcKAbuVpDSo6e1SHQ123jGKd50vEEazoXZVglaYrP9xkM+6ZThkNsgwBE4IjKiG2fnwzIahXbpoWhEJs1wDRr1nXjKGmJwvCeaAuRLxftnoAA=
    - secure: Ehz27XNRI8zojuSnDIoZDHM4GHSm8i0otjqoE07/d9jxJqIw2v3tJ/BXYXarCr/XbA3us/oa178jpm7XDNmcpPXL1QRTOVJrRY2M+MTMUOt/9x1BcWhnjYEb9SFAczC4rzN7QzqsZEDUoRNCMNcuiPGenKJhJqmlwJeKtRkosYy+b2VaLvwesOCTorWU5EkmcIs7d8ybgWVPPLbZRPeK/dk6RAxciPRfZj4/clvTq7Wa69LyTdg970kv7POWqsGjRlSRzqijLDHLnEZyJ+ggPQesMbLXn0041YWB6y+Vi2ZegUFrKuhTqxRpHqc4alhUtRpixATgbJvi84eNvBIHRbferLSjfQmUe6kGGRc+RaOYoQQ9vQkslyyNK72xbwxLvhNrGc5e6YTj+TGbL5lNU8emJe2kZAzLthKdYuD4iJYrkGApAbcH9rVnAt+SGiRLwu1mBpgPDG/xpsKQGFAIVv8oLsPJ71TijHZGLbeA5OqQxZFOxVtGzk1dXSnSTMp6GpHMnqT31hUwXAO84eTFnbfRjvussiSAqsPUai+39WltqVUA+pn6IqVmT0tPJXx03gJBkVq6pC8lpD0+6Luh6fCVU5x9puRgKJCIQR2me4h81gDsdvb1VhRTXMfcNaXCR6okX4ZmAF2XSVlKj8QaiPim//RZIa7PzNKFS9iGYR8=
    - secure: mVs+VlmqVdZL8ts101yRSUzUGAV1YEJvr4j9XTwC2ErjfvfAbKK8pOiAI4xOYKzkUaQRRgM4xj3ZHU2AJDac7eXNsiRowNZ60/uSSq7BXhNMrjY9Si6KLII8ugKPkTE+O1dJa5JpyKXzNcKQk+haGutOEF09mV/C2FlLcOkpeaOkbZ3NsabjDDVRXPiE5PmGdYBcuO8LDxfSss61volr1MxdJuHWt0t8OieLRs4OJ/4qypiv3jczV9HcUqHb4zZ66/iPTXYktHXrFOyqjKGCJUJqSLd2OMaPeIWQNmGf8+OzuHjSq+1CfTD8CAwwzBSm5lqf7CcuV2P0ydToDe4L2M5jD4ReldYUOb2dP2blhCk8uR1OQm0rdw54r9bswn3vwbWmN+N+82jXqo5zKlR9252FM8QXKlq6G6gKpkDIGuZgExD/48KhwHTOQ+fhIDr6+3RVs7Z4lmghyRK/PYYhFtlZyFFTM2sDl3XXmtZPqBd89B1gewHJd5dGXAFovvgOTZqtTvXv9mkTSKYnAW/ZDIX3/X2LxNv8CqAHPGyRn8trJgf/4OOGAiSRIzz7QiO4BSxjG7t5HccC2YdMSE7OKJ6UsgDJof/taEZIoar2TMK8w+5kKNrdgtF2CjLWQ5dmodYWdEXCuV93t7uJ+v1uus+DtrWgoxISrXSaOi/hLPU=
services:
  - docker

before_install:
  - sudo service mysql stop
  - docker pull takimatraining/devops-training-db
  - docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db

script:
  - |
    mvn clean install sonar:sonar \
    -Dsonar.projectKey=QuentinLautridou_sample-application-students \
    -Dsonar.organization=quentinlautridou-github \
    -Dsonar.host.url=https://sonarcloud.io \
    -Dsonar.login=$SONAR_TOKEN
  # Login to Docker hub
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  # Tag text according to the branch
  - export TAG='if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi'
  # Image name
  - export IMAGE_NAME=qlautridou/sample-application-students
  # Build the image (see Dockerfile) and tag it with the commit ID
  - docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
  # Retag the image with the previously choosen tag
  - docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
  # Push the tagged image to Docker Hub
  - docker push $IMAGE_NAME:$TAG
