language: java
jdk: oraclejdk8

env:
  global:
    - secure: OxWfcJjIp48+JBJbNn+xV0VkszfaEEecdVSTXQk9g/e/dHinrAwv8lrH1MWxqdMfPefiJWnXH/YTfrTSTqslk8SawEs7WU8sqiY8mIDVlHVU9JOlGxNleLzQTjHsW0r6dBNaHZhNv8xzhQuuzHHQ243uiTYxgSN96mGboho10eczcmEgx1tHT6yZ/oWJjKK9jnlBXvkVDYZG7thyVEnBHKkag+XzSxmcPiuVQ/xCfiDksnfCjnCdnk5YBG4K5ySmoFurdeTA1kvbqeEUS0mVUssi6A3XtH9Tu+cPHOx9VUuhI8j3JBBVR5fwSveX/bnST0qZpqAliZGsKjVK+WcHA4sNyF+6m1wf0Z61DF2ZQl7Aen4opTsvcKaZ4d0luQ3PSUsqfev3yq1WUERy04wk5VqMK3/xsENwqf5+i6Xv70i1X2chuY8mnpugobzL4aykI5dG7oLubgzUWvdJqBMZzJiPED7/VWr7gU4m9vIfZ3AntzGn+uebYV6czcMZbt8YfbNjy2/gCNDLNCEhoAp3SaXRMxISHeCU2pK9BcpaHNf+2Jpu2rGQa/+r/86ApTVcKAbuVpDSo6e1SHQ123jGKd50vEEazoXZVglaYrP9xkM+6ZThkNsgwBE4IjKiG2fnwzIahXbpoWhEJs1wDRr1nXjKGmJwvCeaAuRLxftnoAA=
    - secure: 
    - secure: 
services:
  - docker

before_install:
  - sudo service mysql stop
  - docker pull takimatraining/devops-training-db
  - docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db

script:
  - |
    mvn clean install sonar:sonar \
    -Dsonar.projectKey=QuentinLautridou_sample-application-students \
    -Dsonar.organization=quentinlautridou-github \
    -Dsonar.host.url=https://sonarcloud.io \
    -Dsonar.login=$SONAR_TOKEN
  # Login to Docker hub
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  # Tag text according to the branch
  - export TAG='if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH; fi'
  # Image name
  - export IMAGE_NAME=qlautridou/sample-application-students
  # Build the image (see Dockerfile) and tag it with the commit ID
  - docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
  # Retag the image with the previously choosen tag
  - docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
  # Push the tagged image to Docker Hub
  - docker push $IMAGE_NAME:$TAG
